var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:3, 
            maxBounds: [[24.39, -124.84], [49.38, -66.93]] 
        }).setView([39.8283, -98.5795], 4);

        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        // Define the transition point
        var transitionZoom = 6;

        // Group your layers for easy management
        var individualDots = [layer_HistoricSites2025_for_QGIS_2];
        var stateClusters = [
            cluster_AlabamaSites_3, cluster_WashingtonSites_4, cluster_WestVirginiaSites_5, 
            cluster_WisconsinSites_6, cluster_WyomingSites_7, cluster_AlabamaSites_8, 
            cluster_ArkansasSites_9, cluster_ColoradoSites_10, cluster_ConnecticutSites_11, 
            cluster_DelawareSites_12, cluster_FloridaSites_13, cluster_GeorgiaSites_14, 
            cluster_IdahoSites_15, cluster_CaliforniaSites_16, cluster_IllinoisSites_17, 
            cluster_IndianaSites_18, cluster_IowaSites_19, cluster_KansasSites_20, 
            cluster_KentuckySites_21, cluster_LouisianaSites_22, cluster_MaineSites_23, 
            cluster_MarylandSites_24, cluster_MichiganSites_25, cluster_MinnesotaSites_26, 
            cluster_MississippiSites_27, cluster_MissouriSites_28, cluster_MontanaSites_29, 
            cluster_NebraskaSites_30, cluster_NewJerseySites_31, cluster_NewMexicoSites_32, 
            cluster_NewYorkSites_33, cluster_NorthCarolinaSites_34, cluster_NorthDakotaSites_35, 
            cluster_OhioSites_36, cluster_OklahomaSites_37, cluster_OregonSites_38, 
            cluster_PennsylvaniaSites_39, cluster_SouthCarolinaSites_40, cluster_TennesseeSites_41, 
            cluster_TexasSites_42, cluster_UtahSites_43, cluster_VirginiaSites_44
        ];

        function updateVisibility() {
            var zoom = map.getZoom();
            
            // If zoomed in (6 or deeper): Show DOTS, Hide NUMBERS
            if (zoom >= transitionZoom) {
                stateClusters.forEach(function(l) { map.removeLayer(l); });
                individualDots.forEach(function(l) { map.addLayer(l); });
            } 
            // If zoomed out (less than 6): Hide DOTS, Show NUMBERS
            else {
                individualDots.forEach(function(l) { map.removeLayer(l); });
                stateClusters.forEach(function(l) { map.addLayer(l); });
            }
        }

        // Run visibility check on zoom and on initial load
        map.on("zoomend", updateVisibility);
        updateVisibility();

        // Base Layer Setup
        map.createPane('pane_EsriWorldIMagery_0');
        map.getPane('pane_EsriWorldIMagery_0').style.zIndex = 400;
        var layer_EsriWorldIMagery_0 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            pane: 'pane_EsriWorldIMagery_0',
            opacity: 1.0,
            minZoom: 1,
            maxZoom: 28
        }).addTo(map);

        // Standard Label Handling
        var i = 0;
        layer_cb_2024_us_state_500k_1.eachLayer(function(layer) {
            var labelContent = '<div style="color: #000; font-size: 8pt; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['NAME'] + '</div>';
            layer.bindTooltip(labelContent, {permanent: true, offset: [-0, -16], className: 'css_cb_2024_us_state_500k_1'});
            labels.push(layer);
            i++;
        });

        resetLabels([layer_cb_2024_us_state_500k_1]);
        map.on("zoomend", function(){ resetLabels([layer_cb_2024_us_state_500k_1]); });
