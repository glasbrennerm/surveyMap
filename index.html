// 1. Map Initialization
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:3,
            maxBounds: [[24.39, -124.84], [49.38, -66.93]] 
        }).setView([37.8, -96], 4);

        // 2. Base Satellite Layer
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri',
            maxZoom: 18
        }).addTo(map);

        // 3. MASTER TOGGLE FUNCTION
        // We wrap this in a check to prevent "undefined" errors
        function updateMapVisibility() {
            var zoom = map.getZoom();
            
            // Define your groups inside the function to ensure variables are recognized
            var clusterGroup = L.layerGroup([
                cluster_AlabamaSites_3, cluster_WashingtonSites_4, cluster_WestVirginiaSites_5, 
                cluster_WisconsinSites_6, cluster_WyomingSites_7, cluster_AlabamaSites_8, 
                cluster_ArkansasSites_9, cluster_ColoradoSites_10, cluster_ConnecticutSites_11, 
                cluster_DelawareSites_12, cluster_FloridaSites_13, cluster_GeorgiaSites_14, 
                cluster_IdahoSites_15, cluster_CaliforniaSites_16, cluster_IllinoisSites_17, 
                cluster_IndianaSites_18, cluster_IowaSites_19, cluster_KansasSites_20, 
                cluster_KentuckySites_21, cluster_LouisianaSites_22, cluster_MaineSites_23, 
                cluster_MarylandSites_24, cluster_MichiganSites_25, cluster_MinnesotaSites_26, 
                cluster_MississippiSites_27, cluster_MissouriSites_28, cluster_MontanaSites_29, 
                cluster_NebraskaSites_30, cluster_NewJerseySites_31, cluster_NewMexicoSites_32, 
                cluster_NewYorkSites_33, cluster_NorthCarolinaSites_34, cluster_NorthDakotaSites_35, 
                cluster_OhioSites_36, cluster_OklahomaSites_37, cluster_OregonSites_38, 
                cluster_PennsylvaniaSites_39, cluster_SouthCarolinaSites_40, cluster_TennesseeSites_41, 
                cluster_TexasSites_42, cluster_UtahSites_43, cluster_VirginiaSites_44
            ]);

            // FIRST: Wipe everything clean
            map.removeLayer(clusterGroup);
            if(window.layer_HistoricSites2025_for_QGIS_2) {
                map.removeLayer(layer_HistoricSites2025_for_QGIS_2);
            }

            // SECOND: Add only the correct layer
            if (zoom >= 6) {
                layer_HistoricSites2025_for_QGIS_2.addTo(map);
            } else {
                clusterGroup.addTo(map);
            }
        }

        // 4. WAIT FOR DATA: This is the critical fix for the white box
        window.addEventListener('load', function() {
            setTimeout(function() {
                updateMapVisibility();
                map.on('zoomend', updateMapVisibility);
            }, 500); // 0.5 second delay to let scripts settle
        });
